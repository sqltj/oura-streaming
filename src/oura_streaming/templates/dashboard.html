<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Oura Streaming Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/chart.js@4.4.0"></script>
    <style>
        :root {
            --color-sleep: #3b82f6;
            --color-readiness: #f59e0b;
            --color-activity: #10b981;
            --color-bg-dark: #0f172a;
            --color-bg-card: #1e293b;
            --color-border: #334155;
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
        }

        * { box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            background-color: var(--color-bg-dark);
            color: var(--color-text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }

        .nav {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            border-bottom: 1px solid var(--color-border);
            backdrop-filter: blur(10px);
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .chart-card {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }

        .chart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, currentColor, transparent);
            opacity: 0.1;
        }

        .chart-card h3 {
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 20px;
            color: var(--color-text-secondary);
        }

        .chart-card.sleep h3 { color: #60a5fa; }
        .chart-card.readiness h3 { color: #fbbf24; }
        .chart-card.activity h3 { color: #34d399; }

        .chart-wrapper {
            position: relative;
            height: 240px;
            margin-bottom: 16px;
        }

        canvas { max-height: 240px; }

        .chart-stats {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--color-text-secondary);
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        .stat {
            flex: 1;
        }

        .stat-label {
            display: block;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 4px;
            opacity: 0.7;
        }

        .stat-value {
            display: block;
            font-size: 16px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
        }

        .stat.sleep .stat-value { color: var(--color-sleep); }
        .stat.readiness .stat-value { color: var(--color-readiness); }
        .stat.activity .stat-value { color: var(--color-activity); }

        .event-new { animation: slideIn 0.6s ease-out; }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
                background-color: rgba(59, 130, 246, 0.1);
            }
            to {
                opacity: 1;
                transform: translateY(0);
                background-color: transparent;
            }
        }

        .events-table {
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 12px;
            overflow: hidden;
        }

        .events-table thead {
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid var(--color-border);
        }

        .events-table th {
            color: var(--color-text-secondary);
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding: 12px 16px;
        }

        .events-table td {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.05);
            font-size: 13px;
        }

        .events-table tbody tr:hover {
            background: rgba(255,255,255,0.02);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .badge-sleep { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-readiness { background: rgba(245, 158, 11, 0.2); color: #fbbf24; }
        .badge-activity { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .badge-workout { background: rgba(236, 72, 153, 0.2); color: #f472b6; }
        .badge-default { background: rgba(100, 116, 139, 0.2); color: #cbd5e1; }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--color-bg-card);
            border: 1px solid var(--color-border);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
        }

        .status-dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: #10b981;
            box-shadow: 0 0 12px rgba(16, 185, 129, 0.6);
        }

        .status-dot.disconnected {
            background: #ef4444;
            box-shadow: 0 0 12px rgba(239, 68, 68, 0.6);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <nav class="nav">
        <div class="max-w-7xl mx-auto px-6 py-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold tracking-tight mb-1">Oura Analytics</h1>
                    <p class="text-sm text-gray-400">Real-time health metrics dashboard</p>
                </div>
                <div class="status-indicator">
                    <span class="status-dot disconnected" id="connection-status"></span>
                    <span id="status-text">Connecting...</span>
                </div>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-6 py-12">
        <!-- Charts Section -->
        <div class="mb-16">
            <div class="mb-8">
                <h2 class="text-2xl font-bold tracking-tight mb-2">Trends</h2>
                <p class="text-gray-400">7-day rolling averages of your key metrics</p>
            </div>

            <div class="charts-container">
                <!-- Sleep Chart -->
                <div class="chart-card sleep">
                    <h3>Sleep</h3>
                    <div class="chart-wrapper">
                        <canvas id="sleepChart"></canvas>
                    </div>
                    <div class="chart-stats">
                        <div class="stat sleep">
                            <span class="stat-label">Avg Duration</span>
                            <span class="stat-value" id="sleep-avg">--:--</span>
                        </div>
                        <div class="stat sleep">
                            <span class="stat-label">Last Night</span>
                            <span class="stat-value" id="sleep-last">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Readiness Chart -->
                <div class="chart-card readiness">
                    <h3>Readiness</h3>
                    <div class="chart-wrapper">
                        <canvas id="readinessChart"></canvas>
                    </div>
                    <div class="chart-stats">
                        <div class="stat readiness">
                            <span class="stat-label">Avg Score</span>
                            <span class="stat-value" id="readiness-avg">--</span>
                        </div>
                        <div class="stat readiness">
                            <span class="stat-label">Today</span>
                            <span class="stat-value" id="readiness-today">--</span>
                        </div>
                    </div>
                </div>

                <!-- Activity Chart -->
                <div class="chart-card activity">
                    <h3>Activity</h3>
                    <div class="chart-wrapper">
                        <canvas id="activityChart"></canvas>
                    </div>
                    <div class="chart-stats">
                        <div class="stat activity">
                            <span class="stat-label">Avg Steps</span>
                            <span class="stat-value" id="activity-avg">--</span>
                        </div>
                        <div class="stat activity">
                            <span class="stat-label">Today</span>
                            <span class="stat-value" id="activity-today">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div>
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold tracking-tight mb-2">Events</h2>
                    <p class="text-gray-400">Real-time webhook stream</p>
                </div>
                <button onclick="clearEvents()" class="text-sm px-4 py-2 rounded-lg bg-red-900/20 text-red-400 hover:bg-red-900/40 font-medium transition">Clear All</button>
            </div>

            <div class="events-table overflow-x-auto">
                <table class="w-full">
                    <thead>
                        <tr>
                            <th class="text-left">Time</th>
                            <th class="text-left">Type</th>
                            <th class="text-left">Event</th>
                            <th class="text-left">Data Summary</th>
                        </tr>
                    </thead>
                    <tbody id="events-table">
                        {% for event in events %}
                        <tr>
                            <td class="whitespace-nowrap text-gray-400">{{ event.received_at.strftime('%H:%M:%S') }}</td>
                            <td class="whitespace-nowrap">
                                <span class="badge badge-{{ event.event.data_type | replace('_', '-') if event.event.data_type in ['daily_sleep', 'daily_readiness', 'daily_activity', 'workout'] else 'default' }}">
                                    {{ event.event.data_type | replace('_', ' ') }}
                                </span>
                            </td>
                            <td class="whitespace-nowrap">{{ event.event.event_type }}</td>
                            <td class="text-gray-500 font-mono text-xs truncate">{{ event.event.data | truncate(50) }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart data stores
        const chartData = {
            sleep: { dates: [], durations: [] },
            readiness: { dates: [], scores: [] },
            activity: { dates: [], steps: [] }
        };

        const charts = {};

        // Chart configuration helper
        function createChartConfig(label, color, data) {
            return {
                type: 'line',
                data: {
                    labels: data.dates,
                    datasets: [{
                        label: label,
                        data: data.values || [],
                        borderColor: color,
                        backgroundColor: color + '20',
                        borderWidth: 2.5,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6,
                        pointBackgroundColor: color,
                        pointBorderColor: 'var(--color-bg-dark)',
                        pointBorderWidth: 2,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            padding: 12,
                            titleColor: '#f1f5f9',
                            bodyColor: color,
                            borderColor: color,
                            borderWidth: 1,
                            cornerRadius: 8,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            ticks: { color: 'var(--color-text-secondary)', font: { size: 11 } },
                            border: { display: false }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { color: 'var(--color-text-secondary)', font: { size: 10 } },
                            border: { display: false }
                        }
                    }
                }
            };
        }

        // Initialize charts on page load
        window.addEventListener('load', () => {
            const sleepCtx = document.getElementById('sleepChart').getContext('2d');
            charts.sleep = new Chart(sleepCtx, createChartConfig('Sleep Duration', '#3b82f6', chartData.sleep));

            const readinessCtx = document.getElementById('readinessChart').getContext('2d');
            charts.readiness = new Chart(readinessCtx, createChartConfig('Readiness Score', '#f59e0b', chartData.readiness));

            const activityCtx = document.getElementById('activityChart').getContext('2d');
            charts.activity = new Chart(activityCtx, createChartConfig('Activity Steps', '#10b981', chartData.activity));
        });

        // WebSocket connection
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws/events`;
        let socket = new WebSocket(wsUrl);

        const statusDot = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        const tableBody = document.getElementById('events-table');

        socket.onopen = () => {
            statusDot.classList.remove('disconnected');
            statusDot.classList.add('connected');
            statusText.textContent = 'Connected';
        };

        socket.onclose = () => {
            statusDot.classList.remove('connected');
            statusDot.classList.add('disconnected');
            statusText.textContent = 'Disconnected (Retrying...)';
            setTimeout(() => window.location.reload(), 5000);
        };

        socket.onmessage = (event) => {
            const data = JSON.parse(event.data);
            addEventToTable(data);
            updateCharts(data);
        };

        function addEventToTable(event) {
            const row = document.createElement('tr');
            row.className = 'event-new';

            const time = new Date(event.received_at).toLocaleTimeString();
            const summary = JSON.stringify(event.event.data).substring(0, 50) + '...';
            const type = event.event.data_type.replace(/_/g, ' ');

            let badgeClass = 'badge-default';
            if (['daily_sleep', 'daily_readiness', 'daily_activity', 'workout'].includes(event.event.data_type)) {
                badgeClass = 'badge-' + event.event.data_type.replace('_', '-');
            }

            // Build cells safely using DOM methods
            const timeCell = document.createElement('td');
            timeCell.className = 'whitespace-nowrap text-gray-400';
            timeCell.textContent = time;

            const typeCell = document.createElement('td');
            typeCell.className = 'whitespace-nowrap';
            const badgeSpan = document.createElement('span');
            badgeSpan.className = 'badge ' + badgeClass;
            badgeSpan.textContent = type;
            typeCell.appendChild(badgeSpan);

            const eventCell = document.createElement('td');
            eventCell.className = 'whitespace-nowrap';
            eventCell.textContent = event.event.event_type;

            const dataCell = document.createElement('td');
            dataCell.className = 'text-gray-500 font-mono text-xs truncate';
            dataCell.textContent = summary;

            row.appendChild(timeCell);
            row.appendChild(typeCell);
            row.appendChild(eventCell);
            row.appendChild(dataCell);

            tableBody.insertBefore(row, tableBody.firstChild);
            if (tableBody.children.length > 50) {
                tableBody.removeChild(tableBody.lastChild);
            }
        }

        function updateCharts(event) {
            const data = event.event.data;
            const type = event.event.data_type;

            // Parse date from event
            const date = new Date(event.received_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });

            if (type === 'daily_sleep' && data.records && Array.isArray(data.records)) {
                const record = data.records[0];
                if (record && record.total_sleep_duration) {
                    const hours = (record.total_sleep_duration / 3600).toFixed(1);
                    chartData.sleep.dates.push(date);
                    if (chartData.sleep.dates.length > 7) chartData.sleep.dates.shift();
                    chartData.sleep.durations.push(parseFloat(hours));
                    if (chartData.sleep.durations.length > 7) chartData.sleep.durations.shift();

                    if (charts.sleep) {
                        charts.sleep.data.labels = chartData.sleep.dates;
                        charts.sleep.data.datasets[0].data = chartData.sleep.durations;
                        charts.sleep.update('none');
                        document.getElementById('sleep-last').textContent = hours + 'h';
                    }
                }
            } else if (type === 'daily_readiness' && data.records && Array.isArray(data.records)) {
                const record = data.records[0];
                if (record && typeof record.score === 'number') {
                    chartData.readiness.dates.push(date);
                    if (chartData.readiness.dates.length > 7) chartData.readiness.dates.shift();
                    chartData.readiness.scores.push(record.score);
                    if (chartData.readiness.scores.length > 7) chartData.readiness.scores.shift();

                    if (charts.readiness) {
                        charts.readiness.data.labels = chartData.readiness.dates;
                        charts.readiness.data.datasets[0].data = chartData.readiness.scores;
                        charts.readiness.update('none');
                        document.getElementById('readiness-today').textContent = record.score;
                    }
                }
            } else if (type === 'daily_activity' && data.records && Array.isArray(data.records)) {
                const record = data.records[0];
                if (record && typeof record.steps === 'number') {
                    chartData.activity.dates.push(date);
                    if (chartData.activity.dates.length > 7) chartData.activity.dates.shift();
                    chartData.activity.steps.push(record.steps);
                    if (chartData.activity.steps.length > 7) chartData.activity.steps.shift();

                    if (charts.activity) {
                        charts.activity.data.labels = chartData.activity.dates;
                        charts.activity.data.datasets[0].data = chartData.activity.steps;
                        charts.activity.update('none');
                        document.getElementById('activity-today').textContent = record.steps.toLocaleString();
                    }
                }
            }
        }

        async function clearEvents() {
            if (confirm('Clear all stored events?')) {
                await fetch('/events', { method: 'DELETE' });
                tableBody.textContent = '';
            }
        }
    </script>
</body>
</html>
